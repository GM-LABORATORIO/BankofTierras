import React, { useState, useEffect } from 'react';
import { Settings, Wallet, Percent, Save, Loader2, ShieldCheck, Database, History, DollarSign, ToggleLeft, ToggleRight, TrendingUp, Gift, Users as UsersIcon } from 'lucide-react';
import { supabaseService } from '../services/supabaseService';
import { motion } from 'framer-motion';
import { setTestingMode, isTestingMode, calculatePricing } from '../constants/pricing';
import { useWeb3 } from '../context/Web3Context';
import AdminImpactEditor from './AdminImpactEditor';

const AdminPanel = () => {
    const { prices } = useWeb3();
    const [config, setConfig] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(null);
    const [editValues, setEditValues] = useState({});
    const [testingMode, setTestingModeState] = useState(isTestingMode());
    const [activeTab, setActiveTab] = useState('config'); // 'config', 'impact', 'experiences', 'events'

    useEffect(() => {
        loadConfig();
    }, []);

    const loadConfig = async () => {
        setIsLoading(true);
        try {
            let data = await supabaseService.getSystemConfig();

            // Si no hay datos, inicializamos con valores por defecto
            if (!data || data.length === 0) {
                console.log("No config found, seeding defaults...");
                await supabaseService.updateSystemConfig('treasury_wallet', '0xA583f0675a2d6f01ab21DEA98629e9Ee04320108', 'Wallet que recibe el 10% de las comisiones.');
                await supabaseService.updateSystemConfig('platform_fee_percentage', '10', 'Porcentaje de comisión por cada venta de créditos.');
                data = await supabaseService.getSystemConfig();
            }

            setConfig(data);
            const initialValues = {};
            data.forEach(item => {
                initialValues[item.key] = item.value;
            });
            setEditValues(initialValues);
        } catch (error) {
            console.error("Error loading config:", error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleUpdate = async (key) => {
        setIsSaving(key);
        try {
            await supabaseService.updateSystemConfig(key, editValues[key]);
            alert(`Configuración "${key}" actualizada con éxito.`);
            loadConfig();
        } catch (error) {
            console.error(error);
            alert("Error al actualizar: " + error.message);
        } finally {
            setIsSaving(null);
        }
    };

    const handleTogglePricingMode = () => {
        const newMode = !testingMode;
        setTestingMode(newMode);
        setTestingModeState(newMode);

        const pricing = calculatePricing(prices.avax);
        const message = newMode
            ? `✅ Modo Testing Activado\n\n1 tCO2 = 1 EcoToken\n\nPerfecto para pruebas sin gastar muchos tokens.`
            : `⚠️ Modo Producción Activado\n\n1 tCO2 = ${pricing.carbonToEcoToken.toLocaleString()} EcoToken\n\nPrecios reales basados en mercado.\n\nAVAX: $${prices.avax}\nEcoToken: $${pricing.ecoTokenPriceUSD.toFixed(4)}`;

        alert(message);
    };

    if (isLoading) {
        return (
            <div className="flex flex-col items-center justify-center py-20">
                <Loader2 className="animate-spin text-emerald-500 mb-4" size={48} />
                <p className="text-gray-500 font-black uppercase tracking-widest text-xs">Cargando Ajustes del Sistema...</p>
            </div>
        );
    }

    return (
        <div className="space-y-8 pb-20">
            {/* Header */}
            <div className="relative h-48 rounded-[2.5rem] overflow-hidden group">
                <img
                    src="https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&q=80&w=2000"
                    className="absolute inset-0 w-full h-full object-cover grayscale opacity-40"
                    alt="Admin header"
                />
                <div className="absolute inset-0 bg-gradient-to-r from-black via-black/80 to-transparent" />
                <div className="absolute inset-0 flex flex-col justify-center px-10">
                    <div className="flex items-center gap-3 mb-2">
                        <ShieldCheck className="text-emerald-500" size={24} />
                        <h2 className="text-4xl font-black text-white italic uppercase tracking-tighter">Panel de Control</h2>
                    </div>
                    <p className="text-gray-400 text-sm font-bold max-w-md uppercase tracking-widest">
                        Configuración crítica de protocolos y parámetros financieros.
                    </p>
                </div>
            </div>

            {/* Tab Navigation */}
            <div className="flex gap-2 p-1 bg-white/5 rounded-2xl mb-8">
                <button
                    onClick={() => setActiveTab('config')}
                    className={`flex-1 py-4 px-6 rounded-xl text-xs font-black uppercase tracking-wider transition-all flex items-center justify-center gap-2 ${activeTab === 'config' ? 'bg-emerald-500 text-white' : 'text-gray-400 hover:text-white'
                        }`}
                >
                    <Settings size={16} />
                    System Config
                </button>
                <button
                    onClick={() => setActiveTab('impact')}
                    className={`flex-1 py-4 px-6 rounded-xl text-xs font-black uppercase tracking-wider transition-all flex items-center justify-center gap-2 ${activeTab === 'impact' ? 'bg-emerald-500 text-white' : 'text-gray-400 hover:text-white'
                        }`}
                >
                    <TrendingUp size={16} />
                    Pixel Impact
                </button>
                <button
                    onClick={() => setActiveTab('experiences')}
                    className={`flex-1 py-4 px-6 rounded-xl text-xs font-black uppercase tracking-wider transition-all flex items-center justify-center gap-2 ${activeTab === 'experiences' ? 'bg-emerald-500 text-white' : 'text-gray-400 hover:text-white'
                        }`}
                >
                    <Gift size={16} />
                    Experiences
                </button>
                <button
                    onClick={() => setActiveTab('events')}
                    className={`flex-1 py-4 px-6 rounded-xl text-xs font-black uppercase tracking-wider transition-all flex items-center justify-center gap-2 ${activeTab === 'events' ? 'bg-emerald-500 text-white' : 'text-gray-400 hover:text-white'
                        }`}
                >
                    <UsersIcon size={16} />
                    Events
                </button>
            </div>

            {/* Tab Content: System Config */}
            {activeTab === 'config' && (
                <div className="grid lg:grid-cols-2 gap-8">
                    {/* Configuration Cards */}
                    <div className="space-y-6">
                        <h3 className="text-sm font-black text-gray-500 uppercase tracking-widest px-4 flex items-center gap-2">
                            <Settings size={16} /> Ajustes Globales
                        </h3>

                        {config.map((item) => (
                            <div key={item.key} className="bg-[#0a0a0a] border border-white/5 p-8 rounded-[2rem] hover:border-emerald-500/20 transition-all">
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-white/5 rounded-xl">
                                            {item.key.includes('wallet') ? <Wallet className="text-emerald-400" /> : <Percent className="text-blue-400" />}
                                        </div>
                                        <div>
                                            <div className="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">{item.key.replace(/_/g, ' ')}</div>
                                            <div className="text-sm font-bold text-white">{item.description}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4">
                                    <input
                                        type="text"
                                        value={editValues[item.key] || ''}
                                        onChange={(e) => setEditValues({ ...editValues, [item.key]: e.target.value })}
                                        className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm font-mono text-emerald-400 focus:border-emerald-500 outline-none transition-all"
                                    />
                                    <button
                                        onClick={() => handleUpdate(item.key)}
                                        disabled={isSaving === item.key}
                                        className="bg-emerald-500 text-white px-6 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-600 transition-all flex items-center gap-2 disabled:opacity-50"
                                    >
                                        {isSaving === item.key ? <Loader2 className="animate-spin" size={14} /> : <Save size={14} />}
                                        Guardar
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Pricing Mode Toggle */}
                    <div className="space-y-6">
                        <h3 className="text-sm font-black text-gray-500 uppercase tracking-widest px-4 flex items-center gap-2">
                            <DollarSign size={16} /> Modo de Precios
                        </h3>

                        <div className="bg-[#0a0a0a] border border-white/5 p-8 rounded-[2rem] hover:border-emerald-500/20 transition-all">
                            <div className="space-y-6">
                                <div className="flex justify-between items-start">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-white/5 rounded-xl">
                                            {testingMode ? (
                                                <ToggleLeft className="text-yellow-400" size={24} />
                                            ) : (
                                                <ToggleRight className="text-emerald-400" size={24} />
                                            )}
                                        </div>
                                        <div>
                                            <div className="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1">
                                                Exchange Rate Mode
                                            </div>
                                            <div className="text-lg font-bold text-white">
                                                {testingMode ? 'Testing (1:1)' : 'Production (Dynamic)'}
                                            </div>
                                        </div>
                                    </div>
                                    <div className={`px-3 py-1.5 rounded-full text-[8px] font-black uppercase tracking-wider ${testingMode
                                        ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
                                        : 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                                        }`}>
                                        {testingMode ? 'Testing' : 'Live'}
                                    </div>
                                </div>

                                <div className="bg-white/5 rounded-xl p-4 space-y-2 text-xs">
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">AVAX Price</span>
                                        <span className="font-bold text-white">${prices.avax}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">EcoToken Price</span>
                                        <span className="font-bold text-white">
                                            ${(0.001 * prices.avax).toFixed(4)}
                                        </span>
                                    </div>
                                    <div className="h-px bg-white/10 my-2" />
                                    <div className="flex justify-between">
                                        <span className="text-gray-400">Exchange Rate</span>
                                        <span className="font-bold text-emerald-400">
                                            {testingMode ? '1:1' : `1 tCO2 = ${calculatePricing(prices.avax).carbonToEcoToken.toLocaleString()} $BoT`}
                                        </span>
                                    </div>
                                </div>

                                <button
                                    onClick={handleTogglePricingMode}
                                    className={`w-full py-4 rounded-xl font-black text-xs uppercase tracking-widest transition-all flex items-center justify-center gap-2 ${testingMode
                                        ? 'bg-emerald-500 text-white hover:bg-emerald-600'
                                        : 'bg-yellow-500 text-black hover:bg-yellow-600'
                                        }`}
                                >
                                    {testingMode ? (
                                        <>
                                            <ToggleRight size={16} />
                                            Activar Modo Producción
                                        </>
                                    ) : (
                                        <>
                                            <ToggleLeft size={16} />
                                            Volver a Testing
                                        </>
                                    )}
                                </button>

                                <p className="text-[9px] text-gray-500 text-center leading-relaxed">
                                    {testingMode
                                        ? 'Modo Testing: Usa tasa 1:1 para pruebas sin gastar muchos tokens.'
                                        : 'Modo Producción: Precios reales basados en mercado de carbono ($25/tCO2).'}
                                </p>
                            </div>
                        </div>

                        <h3 className="text-sm font-black text-gray-500 uppercase tracking-widest px-4 flex items-center gap-2 mt-8">
                            <History size={16} /> Estado del Protocolo
                        </h3>

                        <div className="bg-[#0a0a0a] border border-white/5 p-8 rounded-[2rem] h-full">
                            <div className="space-y-8">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-emerald-500/10 rounded-2xl">
                                        <Database className="text-emerald-500" size={24} />
                                    </div>
                                    <div>
                                        <div className="text-lg font-black text-white italic tracking-tighter italic">SUPABASE NODE: ONLINE</div>
                                        <div className="text-[10px] text-emerald-400 font-bold uppercase tracking-widest">Sincronización en Tiempo Real Activa</div>
                                    </div>
                                </div>

                                <div className="h-px bg-white/5" />

                                <div className="space-y-4">
                                    <div className="text-[10px] font-black text-gray-600 uppercase tracking-widest italic">Últimos Eventos</div>
                                    {[
                                        "Actualización de Tasa de Cambio (AVAX/COP)",
                                        "Verificación de Proyecto ID: AMZ-442",
                                        "Compra confirmada por 50 tokens $CARBON",
                                        "Nuevo originador registrado en Amazonas"
                                    ].map((log, i) => (
                                        <div key={i} className="flex items-center gap-3 text-xs text-gray-500">
                                            <div className="w-1.5 h-1.5 rounded-full bg-emerald-500/30" />
                                            {log}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    )
}

{/* Tab Content: Pixel Impact */ }
{
    activeTab === 'impact' && (
        <AdminImpactEditor />
    )
}

{/* Tab Content: Experiences (Coming Soon) */ }
{
    activeTab === 'experiences' && (
        <div className="bg-[#0a0a0a] border border-white/5 p-12 rounded-[2rem] text-center">
            <Gift className="w-16 h-16 text-gray-600 mx-auto mb-4" />
            <h3 className="text-xl font-black text-white mb-2">Premium Experiences Manager</h3>
            <p className="text-gray-500 text-sm">Coming soon: Add trips, webinars, and live-cams</p>
        </div>
    )
}

{/* Tab Content: Events (Coming Soon) */ }
{
    activeTab === 'events' && (
        <div className="bg-[#0a0a0a] border border-white/5 p-12 rounded-[2rem] text-center">
            <UsersIcon className="w-16 h-16 text-gray-600 mx-auto mb-4" />
            <h3 className="text-xl font-black text-white mb-2">Community Events Manager</h3>
            <p className="text-gray-500 text-sm">Coming soon: Create reforestation, cleanup, and webinar events</p>
        </div>
    )
}
        </div >
    );
};

export default AdminPanel;
